<!-- Previous HTML remains exactly the same until the scripts section -->
<script>
    // Initialize EmailJS
    (function() {
      emailjs.init("QzPU4nIsl3TTDh4xn");
    })();

    // Store form data globally
    let formData = {};

    // Mobile menu toggle
    document.querySelector('.mobile-menu-toggle').addEventListener('click', function() {
      document.querySelector('.site-header').classList.toggle('menu-open');
    });

    // Form submission handler
    document.getElementById('registrationForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (!this.checkValidity()) {
        this.reportValidity();
        return;
      }

      // Capture ALL form data before payment
      formData = {
        fullName: document.getElementById("fullName").value,
        email: document.getElementById("email").value,
        phone: document.getElementById("phone").value,
        businessExperience: document.getElementById("businessExperience").value,
        businessDescription: document.getElementById("businessDescription").value,
        paymentOption: document.querySelector('input[name="paymentOption"]:checked').value,
        date: new Date().toLocaleDateString()
      };

      // Show payment options
      this.style.display = 'none';
      document.getElementById('successMessage').style.display = 'block';
      document.getElementById('paymentOptions').style.display = 'block';
      
      // Show correct PayPal button
      const paymentOption = formData.paymentOption;
      if (paymentOption === 'onetime') {
        document.getElementById('paypal-one-time').classList.remove('hidden');
        renderOneTimeButton();
      } else {
        document.getElementById('paypal-subscription').classList.remove('hidden');
        renderSubscriptionButton();
      }
    });

    // PayPal Buttons
    function renderOneTimeButton() {
      paypal.Buttons({
        style: { 
          shape: 'rect', 
          color: 'gold', 
          layout: 'vertical',
          label: 'paypal'
        },
        createSubscription: function(data, actions) {
          return actions.subscription.create({
            plan_id: 'P-2Y9180536W353780GM72T6WQ'
          });
        },
        onApprove: function(data, actions) {
          // Send form data AFTER successful payment
          sendFormData(formData);
          window.location.href = 'https://executivediscovery.github.io/businessblueprint/thankyou.html';
        },
        onError: function(err) {
          console.error('Payment error:', err);
          document.getElementById('errorMessage').style.display = 'block';
        }
      }).render('#paypal-button-container-P-2Y9180536W353780GM72T6WQ');
    }

    function renderSubscriptionButton() {
      paypal.Buttons({
        style: { 
          shape: 'rect', 
          color: 'gold', 
          layout: 'vertical',
          label: 'subscribe'
        },
        createSubscription: function(data, actions) {
          return actions.subscription.create({
            plan_id: 'P-75L54121H53220933M72SWBQ'
          });
        },
        onApprove: function(data, actions) {
          // Send form data AFTER successful payment
          sendFormData(formData);
          window.location.href = 'https://executivediscovery.github.io/businessblueprint/thankyou.html';
        },
        onError: function(err) {
          console.error('Payment error:', err);
          document.getElementById('errorMessage').style.display = 'block';
        }
      }).render('#paypal-button-container-P-75L54121H53220933M72SWBQ');
    }

    function sendFormData(data) {
      emailjs.send("service_lnrg1h1", "template_aehp1ev", {
        fullName: data.fullName,
        email: data.email,
        phone: data.phone,
        businessExperience: data.businessExperience,
        businessDescription: data.businessDescription,
        paymentOption: data.paymentOption === 'onetime' ? 'One-time ($600)' : 'Monthly ($300 x 2)',
        date: data.date
      }).then(
        () => console.log('Email sent successfully'),
        (error) => console.error('Email failed:', error)
      );
    }
</script>
